#!/usr/bin/env ruby

require "open3"

# Non-interactive commands — safe to capture all streams
def run(cmd)
  stdout, stderr, status = Open3.capture3(cmd)
  [stdout.chomp, stderr.chomp, status]
end

def run!(cmd)
  stdout, = run(cmd)
  stdout
end

# Interactive commands — use backticks/system so gum/fzf can access the TTY

def pick_session
  sessions = run!("tmux list-sessions -F '\#{session_name}'")
  if sessions.empty?
    $stderr.puts "No tmux sessions."
    exit 1
  end

  selected = `echo '#{sessions}' | fzf --prompt='Kill session: '`.chomp
  if selected.empty?
    $stderr.puts "No session selected."
    exit 1
  end
  selected
end

def session_dir(name)
  out, _, status = run("tmux show-environment -t #{name} SESSION_DIR")
  return nil unless status.success?
  out.sub(/^SESSION_DIR=/, "")
end

def session_repo(name)
  out, _, status = run("tmux show-environment -t #{name} SESSION_REPO")
  return nil unless status.success?
  out.sub(/^SESSION_REPO=/, "")
end

def worktree?(dir, repo)
  return false if dir.nil? || repo.nil?
  dir != repo
end

def remove_worktree(repo, dir)
  _, err, status = run("git -C #{repo} worktree remove #{dir}")
  return true if status.success?

  $stderr.puts "Worktree removal failed: #{err}"
  `gum confirm "Force remove worktree? (discards changes)"`
  if $?.success?
    _, err2, status2 = run("git -C #{repo} worktree remove --force #{dir}")
    unless status2.success?
      $stderr.puts "Force removal failed: #{err2}"
      return false
    end
    return true
  end

  false
end

def session_count
  run!("tmux list-sessions -F '\#{session_name}'").split("\n").size
end

# --- Main ---

name = ARGV[0]
name = pick_session unless name

unless run("tmux has-session -t #{name} 2>/dev/null")[2].success?
  $stderr.puts "Session '#{name}' does not exist."
  exit 1
end

if session_count <= 1
  $stderr.puts "Warning: '#{name}' is the last session. Tmux will exit."
  `gum confirm "Continue?"`
  exit 0 unless $?.success?
end

dir = session_dir(name)
repo = session_repo(name)

if worktree?(dir, repo)
  `gum confirm "Remove worktree at #{dir}?"`
  if $?.success?
    remove_worktree(repo, dir)
  end
end

run!("tmux kill-session -t #{name}")
puts "Session '#{name}' closed."
